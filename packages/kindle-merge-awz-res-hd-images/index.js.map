{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2019/2/26.\n */\n\nimport path = require('path');\nimport { async as crossSpawnAsync, sync as crossSpawnSync } from 'cross-spawn-extra';\nimport {\n\tSpawnOptions,\n\tSpawnSyncOptions,\n\tSpawnSyncOptionsWithBufferEncoding,\n\tSpawnSyncOptionsWithStringEncoding,\n} from \"cross-spawn-extra/type\";\nimport fs = require('fs-extra');\nimport nanoid = require('nanoid');\nimport os = require('os');\nimport { Console } from 'debug-color2';\nimport moment = require('moment');\nimport FastGlob = require('fast-glob');\nimport kindlehdunpack = require('kindlehdunpack');\nimport naturalCompare = require('string-natural-compare');\nimport JSZip = require('jszip');\n\nimport { _spawnOptions, Bluebird, os_tmpdir, tmpdir } from '@node-kindle/utils';\n\nexport function handleFile({\n\tazwFile,\n\tresFile,\n}: {\n\tazwFile: string,\n\tresFile: string,\n}, outPath?: string)\n{\n\ttry\n\t{\n\t\tazwFile = fs.realpathSync(azwFile);\n\t}\n\tcatch (e)\n\t{\n\t\tthrow new Error(`檔案不存在 ${azwFile}`)\n\t}\n\n\ttry\n\t{\n\t\tresFile = fs.realpathSync(resFile);\n\t}\n\tcatch (e)\n\t{\n\t\tthrow new Error(`檔案不存在 ${resFile}`)\n\t}\n\n\toutPath = outPath || process.cwd();\n\n\tlet tmpPath = tmpdir();\n\ttmpPath = path.join(__dirname, 'test', 'temp');\n\n\tlet azwFileTmp = path.join(tmpPath, 'tmp.azw');\n\tlet resFileTmp = path.join(tmpPath, 'tmp.res');\n\n\tfs.ensureDirSync(tmpPath);\n\n\tfs.copyFileSync(azwFile, azwFileTmp);\n\tfs.copyFileSync(resFile, resFileTmp);\n\n\tcrossSpawnSync(path.join(__dirname, 'bin-exe', 'kindleunpack.exe'), [\n\t\tazwFileTmp,\n\t], _spawnOptions({\n\t\tcwd: tmpPath,\n\t}));\n\n\tlet path_imgs_hd = path.join(tmpPath, 'imgs_hd');\n\n\tfs.ensureDirSync(path_imgs_hd);\n\n\tkindlehdunpack.handleFile(resFileTmp, {\n\t\toutput: path_imgs_hd,\n\t});\n\n\tlet imgs_epub = list_imgs_epub(tmpPath);\n\tlet imgs_hd = list_imgs(path_imgs_hd);\n\n\tif (!imgs_epub.length)\n\t{\n\t\tthrow new Error(`azw 中不存在圖片 或者 提取失敗`);\n\t}\n\n\tif (!imgs_hd.length)\n\t{\n\t\tthrow new Error(`res 中不存在圖片 或者 提取失敗`);\n\t}\n\n\tlet list_match = match_images(imgs_hd, imgs_epub);\n\n\tlist_match\n\t\t.forEach(function (data)\n\t\t{\n\t\t\tif (data.epub)\n\t\t\t{\n\t\t\t\tfs.copyFileSync(data.hd, data.epub);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconsole.warn(`找不到配對的圖片 ${path.basename(data.hd)}`);\n\t\t\t}\n\t\t});\n\n\treturn lazy_epub(tmpPath, list_match)\n\t\t.then(async function (data)\n\t\t{\n\t\t\tlet new_epub = path.join(outPath, path.basename(azwFile)) + '.hd.epub';\n\t\t\tlet new_mobi = path.join(outPath, path.basename(azwFile)) + '.hd.mobi';\n\n\t\t\tawait fs.writeFile(new_epub, data.buffer);\n\n\t\t\tawait crossSpawnAsync(path.join(__dirname, 'bin-exe', 'kindlegen.exe'), [\n\t\t\t\tnew_epub,\n\t\t\t], _spawnOptions({\n\t\t\t\tcwd: path.dirname(new_epub),\n\t\t\t}));\n\n\t\t\tawait fs.remove(tmpPath);\n\n\t\t\treturn {\n\t\t\t\tazwFile,\n\t\t\t\tresFile,\n\t\t\t\tnew_epub,\n\t\t\t\tnew_mobi,\n\t\t\t\tbuffer: data.buffer,\n\t\t\t}\n\t\t})\n\t\t;\n}\n\nexport async function lazy_epub(tmpPath: string, list_match: ReturnType<typeof match_images>)\n{\n\tlet epub_root = path.join(tmpPath, 'tmp', 'mobi8');\n\n\tlet zip_buf = await fs.readFile(path.join(epub_root, 'tmp.epub'));\n\n\tlet zip = await JSZip\n\t\t.loadAsync(zip_buf)\n\t;\n\n\tawait Bluebird.map(list_match, async function (data)\n\t{\n\t\tif (data.epub)\n\t\t{\n\t\t\tlet key = data.epub.replace(/^.+(?=OEBPS\\/)/, '');\n\n\t\t\tlet buf = await fs.readFile(data.hd);\n\n\t\t\tawait zip.file(key, buf, {\n\t\t\t\tbinary: true,\n\t\t\t})\n\t\t}\n\t});\n\n\tlet new_zip_buf = await zip.generateAsync({\n\t\ttype: 'nodebuffer',\n\t});\n\n\tlet file = path.join(tmpPath, 'tmp.new.epub');\n\n\tawait fs.writeFile(file, new_zip_buf);\n\n\treturn {\n\t\tfile,\n\t\tbuffer: new_zip_buf,\n\t}\n}\n\nexport function match_images(imgs_hd: string[], imgs_epub: string[])\n{\n\treturn imgs_hd\n\t\t.reduce(function (a, file)\n\t\t{\n\t\t\tlet idkey = (file.match(/(\\d+)\\.jpeg$/) || [])[1];\n\t\t\tlet i: number;\n\n\t\t\tif (idkey && (i = parseInt(idkey)) && i > 0)\n\t\t\t{\n\t\t\t\ti--;\n\n\t\t\t\ta.push({\n\t\t\t\t\tindex: i,\n\t\t\t\t\thd: file,\n\t\t\t\t\tepub: imgs_epub[i],\n\t\t\t\t})\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ta.push({\n\t\t\t\t\thd: file,\n\t\t\t\t\tepub: null,\n\t\t\t\t})\n\t\t\t}\n\n\t\t\treturn a;\n\t\t}, [] as {\n\t\t\tindex?: number,\n\t\t\thd: string,\n\t\t\tepub: string,\n\t\t}[])\n\t\t;\n}\n\nexport function list_imgs(tmpPath: string)\n{\n\tlet imgs_epub = FastGlob.sync<string>([\n\t\t'*.jpeg',\n\t\t'cover*.jpeg',\n\t\t'!*.jpeg.hd.jpeg',\n\t], {\n\t\tcwd: tmpPath,\n\t\tabsolute: true,\n\t});\n\n\timgs_epub.sort();\n\n\treturn imgs_epub;\n}\n\nexport function list_imgs_epub(tmpPath: string, mode?: boolean)\n{\n\tlet r = /^(cover)/;\n\n\treturn list_imgs(path.join(tmpPath, 'tmp', 'mobi8', 'OEBPS', 'Images'))\n\t\t.sort(function (a, b)\n\t\t{\n\t\t\ta = path.basename(a);\n\t\t\tb = path.basename(b);\n\n\t\t\tif (1)\n\t\t\t{\n\t\t\t\tlet aa = a.replace(/^\\D+/, '');\n\t\t\t\tlet bb = b.replace(/^\\D+/, '');\n\n\t\t\t\tif (aa.length == bb.length && /^\\d+/.test(aa))\n\t\t\t\t{\n\t\t\t\t\treturn naturalCompare(aa, bb);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet aa = r.test(a);\n\t\t\tlet bb = r.test(b);\n\n\t\t\tif (aa && !bb)\n\t\t\t{\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\telse if (!aa && bb)\n\t\t\t{\n\t\t\t\treturn -1;\n\t\t\t}\n\n\t\t\treturn 0;\n\t\t})\n\t\t;\n}\n\nexport default exports as typeof import('./index');\n\n\n"]}